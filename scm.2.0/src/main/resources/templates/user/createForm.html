<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:th="http://www.thymeleaf.org">

<head>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        clifford: '#da373d',
                    }
                }
            }
        }
    </script>
    <title>CreateJanAdhaar</title>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
        }
    </style>
</head>

<body>
    <div class="mt-4 text-center">
        <h2 class="font-bold text-lg text-blue-950">New Enrollment Form</h2>
    </div>
<form id="main-form" th:action="@{/user/fam/add}" method="post">


        <div class="mx-px flex flex-col bg-sky-50 rounded-lg p-4 shadow-sm">
			<div th:object="${memberInfoForm}">
            <h3 class="italic text-lg text-sky-500">Personal Details</h3>

            <div class="mt-4 flex flex-row space-x-2">
                <div class="flex-1">
                    <label class="text-black" for="name">Name</label><span class="text-red-500">*</span>
                    <input th:field="*{name}" id="main-name" placeholder="your name" class="w-full bg-white rounded-md border-gray-300 text-black px-2 py-1" type="text">
                </div>
                <div class="flex-1">
                    <label class="text-black" for="father-name">Father Name</label><span class="text-red-500">*</span>
                    <input th:field="*{fName}" id="father-name" placeholder="father name" class="w-full bg-white rounded-md border-gray-300 text-black px-2 py-1" type="text">
                </div>
                <div class="flex-1">
                    <label class="text-black" for="mother-name">Mother Name</label><span class="text-red-500">*</span>
                    <input th:field="*{mName}" id="mother-name" placeholder="mother name" class="w-full bg-white rounded-md border-gray-300 text-black px-2 py-1" type="text">
                </div>
            </div>

            <div class="mt-4 flex flex-row space-x-2">
                <div class="flex-1">
                    <label class="text-black" for="dob">DoB</label><span class="text-red-500">*</span>
                    <input th:field="*{dob}" id="dob" placeholder="(YYYY-MM-DD)" class="w-full bg-white rounded-md border-gray-300 text-black px-2 py-1" type="text" onfocus="(this.type='date')" onblur="(this.type='text')">
                </div>
                <div class="flex-1">
                    <label class="text-black" for="gender">Gender</label><span class="text-red-500">*</span>
                    <select th:field="*{gender}" id="gender" class="w-full bg-white rounded-md border-gray-300 text-black px-2 py-1">
                        <option value="">Your Gender</option>
                        <option value="female">Female</option>
                        <option value="male">Male</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="text-black" for="mAdhar">Adhar<span class="text-red-500">*</span></label>
                    <input th:field="*{mAdhar}" id="mAdhar" name="mAdhar" placeholder="12 digit adhar Number" class="w-full bg-white rounded-md border-gray-300 text-black px-2 py-1" type="text" pattern="\d{12}" maxlength="12">
                </div>
            </div>
        </div>
        </div>

        <!-- MemberProfessionForm section -->
         <div class="mx-px flex flex-col bg-sky-50 rounded-lg p-4 shadow-sm">
        <div th:object="${memberProfessionForm}">
            <h3 class="mt-4 italic text-lg text-sky-500">Professional Details</h3>

            <div class="mt-4 flex flex-row space-x-2">
                <div class="flex-1">
                    <label class="text-black" for="education">Education</label><span class="text-red-500">*</span>
                    <input th:field="*{education}" id="education" placeholder="your highest education" class="w-full bg-white rounded-md border-gray-300 text-black px-2 py-1" type="text">
                </div>
                <div class="flex-1">
                    <label class="text-black" for="occupation">Occupation</label><span class="text-red-500">*</span>
                    <input th:field="*{occupation}" id="occupation" placeholder="your occupation" class="w-full bg-white rounded-md border-gray-300 text-black px-2 py-1" type="text">
                </div>
                <div class="flex-1">
                    <label class="text-black" for="resident">Resident</label><span class="text-red-500">*</span>
                    <input th:field="*{resident}" id="resident" placeholder="resident" class="w-full bg-white rounded-md border-gray-300 text-black px-2 py-1" type="text">
                </div>
            </div>

            <div class="mt-4 flex flex-row space-x-2">
                <div class="flex-1">
                    <label class="text-black" for="religion">Religion</label><span class="text-red-500">*</span>
                    <input th:field="*{religion}" id="religion" placeholder="religion" class="w-full bg-white rounded-md border-gray-300 text-black px-2 py-1" type="text">
                </div>
                <div class="flex-1">
                    <label class="text-black" for="category">Category</label><span class="text-red-500">*</span>
                    <select th:field="*{category}" id="category" class="w-full bg-white rounded-md border-gray-300 text-black px-2 py-1">
                        <option value="">category</option>
                        <option value="general">General</option>
                        <option value="obc">OBC</option>
                        <option value="scst">SC / STC</option>
                    </select>
                </div>
                <div class="flex-1">
                    <label class="text-black" for="mobile-number">Mobile Number</label><span class="text-red-500">*</span>
                    <input th:field="*{mobileNumber}" id="mobile-number" name="mobile-number" placeholder="10 digit mobile Number" class="w-full bg-white rounded-md border-gray-300 text-black px-2 py-1" type="text" pattern="\d{10}" maxlength="10">
                </div>
            </div>
        </div>

        <div class="mt-4 flex justify-end">
            <button type="submit" id="add-member-button" class="bg-white text-black rounded-md border-gray-300 text-sm px-4 py-2 hover:bg-sky-50 border shadow-sm">Add Member</button>

        </div>
        
    </form>

    <div th:if="${session.message}">
        <p th:text="${session.message.content}" class="text-green-500 text-center mt-4"></p>
    </div>
<!--    Family members enrollment   --> 
    <table id="members-table" class="mt-4 w-full bg-white rounded-lg shadow-sm border-separate border border-sky-500 table-fixed">
        <thead>
            <tr class="text-sky-500" data-member-id="123">
                <th class="border border-sky-500">HoF</th>
                <th class="border border-sky-500">Name</th>
                <th class="border border-sky-500">Age</th>
                <th class="border border-sky-500">Gender</th>
                <th class="border border-sky-500">Relation</th>
            </tr>
        </thead>
        <tbody id="members-table-body" style="
    text-align: center">
            <!-- Member rows will be added here dynamically -->
        </tbody>
    </table>
    <div class="mt-4 flex justify-center">
                <button id="submit-button" type="button" class="inline-block py-2 px-6 rounded-md bg-[#0EA5E9] hover:bg-white hover:text-[#0EA5E9] focus:text-[#0EA5E9] focus:bg-gray-200 text-gray-50 font-bold leading-loose transition duration-200">
                    Submit
                </button>
            </div>
         </div>

  <script>
  // ###################### Add Member ############################
  function calculateAge(dob) {
	    // Convert date string in YYYY-MM-DD format to a Date object
	    const parts = dob.split("-");
	    const birthDate = new Date(parts[0], parts[1] - 1, parts[2]); // Month is 0-based
	    const today = new Date();
	    let age = today.getFullYear() - birthDate.getFullYear();
	    const m = today.getMonth() - birthDate.getMonth();
	    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
	        age--;
	    }
	    return age;
	}


    function validateForm() {
        const name = document.getElementById('main-name').value;
        const dob = document.getElementById('dob').value;
        const gender = document.getElementById('gender').value;
        const adhar = document.getElementById('mAdhar').value;
        const education = document.getElementById('education').value;
        const occupation = document.getElementById('occupation').value;
        const resident = document.getElementById('resident').value;
        const religion = document.getElementById('religion').value;
        const category = document.getElementById('category').value;
        const mobile = document.getElementById('mobile-number').value;

        return name && dob && gender && adhar && education && occupation && resident && religion && category && mobile;
    }

    function submitFormViaAjax(formData) {
        fetch('/user/fam/add', {
            method: 'POST',
            body: formData,
            headers: {
                'Accept': 'application/json',
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('Member added successfully!');
                
                const membersTableBody = document.getElementById('members-table-body');
                const newRow = membersTableBody.insertRow();

                const hofCell = newRow.insertCell();
                const hofRadio = document.createElement('input');
                hofRadio.type = 'radio';
                hofRadio.name = 'hof';
                hofRadio.disabled = !(data.age > 18 && data.gender === 'female');  // Enable only if age > 18 and female
                hofCell.appendChild(hofRadio);

                newRow.insertCell().innerText = data.name;
                newRow.insertCell().innerText = data.age;
                newRow.insertCell().innerText = data.gender;
                const relationCell = newRow.insertCell();
                const relationSelect = document.createElement('select');
                const relationOptions = ['Self', 'Spouse', 'Mother', 'Grandmother', 'Sister', 'Brother', 'Father', 'Grandfather', 'Son', 'Daughter'];
                relationOptions.forEach(option => {
                    const opt = document.createElement('option');
                    opt.value = option;
                    opt.textContent = option;
                    relationSelect.appendChild(opt);
                });
                relationCell.appendChild(relationSelect);

                document.getElementById('main-form').reset();
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('There was an error adding the member.');
        });
    }

    document.getElementById('add-member-button').addEventListener('click', function (event) {
        event.preventDefault(); // Prevent default form submission

        if (validateForm()) {
            const formData = new FormData(document.getElementById('main-form'));

            // Calculate age and add it to the formData
            const dob = formData.get('dob');
            const age = calculateAge(dob);
            formData.append('age', age);

            submitFormViaAjax(formData);
        } else {
            alert('Please fill in all required fields.');
        }
    });
    // ###################### Submit Family ############################
    $(document).ready(function () {
            $('#submit-button').click(function () {
                var familyMembers = [];
                $('#members-table-body tr').each(function () {
                    var row = $(this);
                    var hofStatus = row.find('input[type="radio"]').is(':checked') ? 'Yes' : 'No';
                    var memberName = row.find('td:nth-child(2)').text(); // Assuming name is in the 2nd column
                    var memberAge = row.find('td:nth-child(3)').text();  // Assuming age is in the 3rd column
                    var memberGender = row.find('td:nth-child(4)').text(); // Assuming gender is in the 4th column
                    var relationWithHof = row.find('td:nth-child(5) select').val();

                    familyMembers.push({
                        hofStatus: hofStatus,
                        memberName: memberName,
                        memberAge: memberAge,
                        memberGender: memberGender,
                        relationWithHof: relationWithHof
                    });
                });

                $.ajax({
                    url: '/saveFamily',
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify(familyMembers),
                    success: function (response) {
                        alert('Family members saved successfully!');
                        window.location.href = '/user/address';
                    },
                    error: function (xhr, status, error) {
                        alert('An error occurred: ' + error);
                    }
                });
            });
        });
</script>
  

</body>

</html>
